<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LicenseSeat SDK v0.3.0 - Live Production Test</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a2e;
      color: #eee;
    }
    h1 { color: #00d4ff; margin-bottom: 5px; }
    h2 { color: #888; font-size: 14px; margin-top: 0; }
    .test-section {
      background: #16213e;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      border-left: 4px solid #444;
    }
    .test-section.running { border-left-color: #f9a825; }
    .test-section.pass { border-left-color: #4caf50; }
    .test-section.fail { border-left-color: #f44336; }
    .test-section h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .test-section pre {
      background: #0f0f23;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
      margin: 5px 0;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .status { font-size: 18px; }
    .pass-icon::before { content: '‚úÖ'; }
    .fail-icon::before { content: '‚ùå'; }
    .running-icon::before { content: '‚è≥'; }
    .skip-icon::before { content: '‚è≠Ô∏è'; }
    #controls {
      display: flex;
      gap: 10px;
      margin: 20px 0;
    }
    button {
      background: #00d4ff;
      color: #000;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover { background: #00a8cc; }
    button:disabled { background: #444; color: #888; cursor: not-allowed; }
    #summary {
      background: #0f3460;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }
    .events-log {
      max-height: 200px;
      overflow-y: auto;
      font-size: 11px;
    }
    .event-item { padding: 2px 0; border-bottom: 1px solid #333; }
    .event-name { color: #00d4ff; }
  </style>
</head>
<body>
  <h1>LicenseSeat SDK</h1>
  <h2>Live Integration Tests (Browser)</h2>

  <div id="configSection" class="test-section">
    <h3>üîß Configuration</h3>
    <p style="font-size: 12px; color: #888; margin: 5px 0 15px 0;">
      Enter your LicenseSeat credentials. Values are stored in localStorage for convenience.
    </p>
    <div style="display: grid; gap: 10px;">
      <label>
        <span style="color: #00d4ff; font-size: 12px;">API Key:</span>
        <input type="password" id="apiKeyInput" placeholder="ls_your_api_key_here" style="width: 100%; padding: 8px; background: #0f0f23; border: 1px solid #444; color: #fff; border-radius: 4px; font-family: monospace;">
      </label>
      <label>
        <span style="color: #00d4ff; font-size: 12px;">Product Slug:</span>
        <input type="text" id="productSlugInput" placeholder="your-product" style="width: 100%; padding: 8px; background: #0f0f23; border: 1px solid #444; color: #fff; border-radius: 4px; font-family: monospace;">
      </label>
      <label>
        <span style="color: #00d4ff; font-size: 12px;">License Key:</span>
        <input type="text" id="licenseKeyInput" placeholder="XXXX-XXXX-XXXX-XXXX" style="width: 100%; padding: 8px; background: #0f0f23; border: 1px solid #444; color: #fff; border-radius: 4px; font-family: monospace;">
      </label>
    </div>
  </div>

  <div id="controls">
    <button id="runTests">Run All Tests</button>
    <button id="resetSDK">Reset SDK</button>
    <button id="clearConfig" style="background: #f44336;">Clear Config</button>
  </div>

  <div id="summary">
    <strong>Summary:</strong> <span id="summaryText">Enter credentials and click "Run All Tests" to start</span>
  </div>

  <div id="testResults"></div>

  <div class="test-section">
    <h3>Event Log</h3>
    <div id="eventLog" class="events-log"></div>
  </div>

  <script type="module">
    // Import from CDN - testing the live published package
    import LicenseSeat, {
      APIError,
      LicenseError,
      ConfigurationError,
      CryptoError
    } from 'https://esm.sh/@licenseseat/js';

    // Configuration from form inputs (stored in localStorage)
    const CONFIG_STORAGE_KEY = 'licenseseat_test_config';

    function getConfig() {
      return {
        API_KEY: document.getElementById('apiKeyInput').value.trim(),
        PRODUCT_SLUG: document.getElementById('productSlugInput').value.trim(),
        LICENSE_KEY: document.getElementById('licenseKeyInput').value.trim()
      };
    }

    function saveConfig() {
      const config = getConfig();
      localStorage.setItem(CONFIG_STORAGE_KEY, JSON.stringify(config));
    }

    function loadConfig() {
      try {
        const saved = localStorage.getItem(CONFIG_STORAGE_KEY);
        if (saved) {
          const config = JSON.parse(saved);
          document.getElementById('apiKeyInput').value = config.API_KEY || '';
          document.getElementById('productSlugInput').value = config.PRODUCT_SLUG || '';
          document.getElementById('licenseKeyInput').value = config.LICENSE_KEY || '';
        }
      } catch (e) { /* ignore */ }
    }

    function clearConfig() {
      localStorage.removeItem(CONFIG_STORAGE_KEY);
      document.getElementById('apiKeyInput').value = '';
      document.getElementById('productSlugInput').value = '';
      document.getElementById('licenseKeyInput').value = '';
    }

    function validateConfig() {
      const config = getConfig();
      if (!config.API_KEY || !config.PRODUCT_SLUG || !config.LICENSE_KEY) {
        alert('Please fill in all configuration fields (API Key, Product Slug, License Key)');
        return false;
      }
      saveConfig();
      return true;
    }

    // Load saved config on page load
    loadConfig();

    // Clear config button
    document.getElementById('clearConfig').onclick = () => {
      clearConfig();
      alert('Configuration cleared');
    };

    let sdk = null;
    const testResults = document.getElementById('testResults');
    const summaryText = document.getElementById('summaryText');
    const eventLog = document.getElementById('eventLog');

    let passed = 0;
    let failed = 0;
    let skipped = 0;

    // Event logging
    function logEvent(name, data) {
      const item = document.createElement('div');
      item.className = 'event-item';
      item.innerHTML = `<span class="event-name">${name}</span>: ${JSON.stringify(data).slice(0, 100)}...`;
      eventLog.prepend(item);
    }

    // Test result UI
    function createTestSection(name) {
      const section = document.createElement('div');
      section.className = 'test-section running';
      section.innerHTML = `
        <h3><span class="status running-icon"></span> ${name}</h3>
        <pre>Running...</pre>
      `;
      testResults.appendChild(section);
      return section;
    }

    function updateTestSection(section, status, message, data = null) {
      section.className = `test-section ${status}`;
      const icon = status === 'pass' ? 'pass-icon' : status === 'fail' ? 'fail-icon' : 'skip-icon';
      section.querySelector('.status').className = `status ${icon}`;
      let content = message;
      if (data) {
        content += '\n\nResponse:\n' + JSON.stringify(data, null, 2);
      }
      section.querySelector('pre').textContent = content;

      if (status === 'pass') passed++;
      else if (status === 'fail') failed++;
      else skipped++;

      updateSummary();
    }

    function updateSummary() {
      summaryText.innerHTML = `<span style="color:#4caf50">${passed} passed</span> | <span style="color:#f44336">${failed} failed</span> | <span style="color:#888">${skipped} skipped</span>`;
    }

    async function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // ============================================
    // TEST SUITE
    // ============================================

    async function runTests() {
      // Validate configuration first
      if (!validateConfig()) return;
      const CONFIG = getConfig();

      testResults.innerHTML = '';
      eventLog.innerHTML = '';
      passed = 0;
      failed = 0;
      skipped = 0;
      updateSummary();

      // Reset any existing SDK (but keep our test config)
      if (sdk) {
        try { sdk.destroy(); } catch (e) {}
      }
      // Clear SDK storage but preserve test config
      const savedTestConfig = localStorage.getItem(CONFIG_STORAGE_KEY);
      localStorage.clear();
      if (savedTestConfig) localStorage.setItem(CONFIG_STORAGE_KEY, savedTestConfig);

      console.log('üöÄ Starting LicenseSeat SDK Live Integration Tests');
      console.log('üì¶ Package loaded from: https://esm.sh/@licenseseat/js');
      console.log(`üîë Product: ${CONFIG.PRODUCT_SLUG}`);

      // ----------------------------------------
      // Test 1: SDK Initialization
      // ----------------------------------------
      let section = createTestSection('1. SDK Initialization with productSlug');
      try {
        sdk = new LicenseSeat({
          apiKey: CONFIG.API_KEY,
          productSlug: CONFIG.PRODUCT_SLUG,
          debug: true,
          autoInitialize: false
        });

        // Subscribe to ALL events for logging
        const events = [
          'license:loaded', 'sdk:reset', 'sdk:destroyed', 'sdk:error',
          'activation:start', 'activation:success', 'activation:error',
          'deactivation:start', 'deactivation:success', 'deactivation:error',
          'validation:start', 'validation:success', 'validation:failed', 'validation:error',
          'validation:offline-success', 'validation:offline-failed',
          'autovalidation:cycle', 'autovalidation:stopped',
          'network:online', 'network:offline',
          'offlineToken:fetching', 'offlineToken:fetched', 'offlineToken:fetchError',
          'offlineToken:ready', 'offlineToken:verified', 'offlineToken:verificationFailed'
        ];
        events.forEach(evt => sdk.on(evt, (data) => logEvent(evt, data)));

        updateTestSection(section, 'pass',
          `SDK initialized successfully\n` +
          `- apiBaseUrl: ${sdk.config.apiBaseUrl}\n` +
          `- productSlug: ${sdk.config.productSlug}\n` +
          `- storagePrefix: ${sdk.config.storagePrefix}`
        );
      } catch (err) {
        updateTestSection(section, 'fail', `Failed: ${err.message}`);
        return;
      }

      // ----------------------------------------
      // Test 2: Configuration Validation
      // ----------------------------------------
      section = createTestSection('2. Configuration Defaults');
      try {
        const checks = [
          ['apiBaseUrl', 'https://licenseseat.com/api/v1', sdk.config.apiBaseUrl],
          ['productSlug', CONFIG.PRODUCT_SLUG, sdk.config.productSlug],
          ['storagePrefix', 'licenseseat_', sdk.config.storagePrefix],
          ['autoValidateInterval', 3600000, sdk.config.autoValidateInterval],
          ['offlineFallbackEnabled', false, sdk.config.offlineFallbackEnabled],
          ['maxRetries', 3, sdk.config.maxRetries]
        ];

        let allPass = true;
        let details = '';
        for (const [key, expected, actual] of checks) {
          const pass = expected === actual;
          details += `${pass ? '‚úì' : '‚úó'} ${key}: ${actual} (expected: ${expected})\n`;
          if (!pass) allPass = false;
        }

        updateTestSection(section, allPass ? 'pass' : 'fail', details);
      } catch (err) {
        updateTestSection(section, 'fail', `Failed: ${err.message}`);
      }

      // ----------------------------------------
      // Test 3: Initial Status (inactive)
      // ----------------------------------------
      section = createTestSection('3. Initial Status (should be inactive)');
      try {
        const status = sdk.getStatus();
        if (status.status === 'inactive') {
          updateTestSection(section, 'pass', `Status is correctly "inactive" before activation`, status);
        } else {
          updateTestSection(section, 'fail', `Expected "inactive", got "${status.status}"`, status);
        }
      } catch (err) {
        updateTestSection(section, 'fail', `Failed: ${err.message}`);
      }

      // ----------------------------------------
      // Test 4: Auth Test
      // ----------------------------------------
      section = createTestSection('4. API Authentication Test');
      try {
        const result = await sdk.testAuth();
        if (result.authenticated) {
          updateTestSection(section, 'pass', 'API key is valid and authenticated', result);
        } else {
          updateTestSection(section, 'fail', 'Authentication failed', result);
        }
      } catch (err) {
        updateTestSection(section, 'fail', `Failed: ${err.message}\n${err.stack}`);
      }

      // ----------------------------------------
      // Test 5: License Activation
      // ----------------------------------------
      section = createTestSection('5. License Activation');
      let activationResult = null;
      try {
        activationResult = await sdk.activate(CONFIG.LICENSE_KEY);

        const checks = [
          activationResult.license_key === CONFIG.LICENSE_KEY,
          typeof activationResult.device_id === 'string',
          typeof activationResult.activated_at === 'string',
          activationResult.activation !== undefined
        ];

        if (checks.every(c => c)) {
          updateTestSection(section, 'pass',
            `License activated successfully!\n` +
            `- license_key: ${activationResult.license_key}\n` +
            `- device_id: ${activationResult.device_id}\n` +
            `- activated_at: ${activationResult.activated_at}`,
            activationResult
          );
        } else {
          updateTestSection(section, 'fail', 'Response missing expected fields', activationResult);
        }
      } catch (err) {
        // If already activated, that's okay - try to continue
        if (err.message?.includes('already activated') || err.data?.error?.code === 'device_already_activated') {
          updateTestSection(section, 'pass', `Device already activated (expected in stress test)\n${err.message}`);
        } else {
          updateTestSection(section, 'fail', `Failed: ${err.message}`, err.data);
        }
      }

      // ----------------------------------------
      // Test 6: Status After Activation
      // ----------------------------------------
      section = createTestSection('6. Status After Activation');
      try {
        const status = sdk.getStatus();
        updateTestSection(section,
          status.status === 'active' || status.status === 'pending' ? 'pass' : 'fail',
          `Status: ${status.status}\nLicense: ${status.license}\nDevice: ${status.device}`,
          status
        );
      } catch (err) {
        updateTestSection(section, 'fail', `Failed: ${err.message}`);
      }

      // ----------------------------------------
      // Test 7: License Validation
      // ----------------------------------------
      section = createTestSection('7. License Validation');
      let validationResult = null;
      try {
        validationResult = await sdk.validateLicense(CONFIG.LICENSE_KEY);

        if (validationResult.valid === true) {
          updateTestSection(section, 'pass',
            `License is VALID\n` +
            `- License status: ${validationResult.license?.status}\n` +
            `- Mode: ${validationResult.license?.mode}\n` +
            `- Plan: ${validationResult.license?.plan_key}\n` +
            `- Active seats: ${validationResult.license?.active_seats}/${validationResult.license?.seat_limit}`,
            validationResult
          );
        } else {
          updateTestSection(section, 'fail', 'Validation returned valid=false', validationResult);
        }
      } catch (err) {
        updateTestSection(section, 'fail', `Failed: ${err.message}`, err.data);
      }

      // ----------------------------------------
      // Test 8: Entitlements Check
      // ----------------------------------------
      section = createTestSection('8. Entitlements Check');
      try {
        const entitlements = validationResult?.active_entitlements || validationResult?.license?.active_entitlements || [];
        let details = `Found ${entitlements.length} entitlement(s):\n`;

        entitlements.forEach(ent => {
          const hasIt = sdk.hasEntitlement(ent.key);
          const check = sdk.checkEntitlement(ent.key);
          details += `\n- "${ent.key}": hasEntitlement=${hasIt}, checkEntitlement.active=${check.active}`;
          if (ent.expires_at) details += `, expires=${ent.expires_at}`;
        });

        // Test non-existent entitlement
        const fakeCheck = sdk.checkEntitlement('nonexistent-feature');
        details += `\n\n- "nonexistent-feature": hasEntitlement=${sdk.hasEntitlement('nonexistent-feature')}, reason=${fakeCheck.reason}`;

        updateTestSection(section, 'pass', details);
      } catch (err) {
        updateTestSection(section, 'fail', `Failed: ${err.message}`);
      }

      // ----------------------------------------
      // Test 9: Cache Verification
      // ----------------------------------------
      section = createTestSection('9. Cache Verification');
      try {
        const cached = sdk.cache.getLicense();
        const deviceId = sdk.cache.getDeviceId();

        if (cached && cached.license_key === CONFIG.LICENSE_KEY) {
          updateTestSection(section, 'pass',
            `Cache working correctly\n` +
            `- Cached license_key: ${cached.license_key}\n` +
            `- Cached device_id: ${cached.device_id}\n` +
            `- getDeviceId(): ${deviceId}\n` +
            `- last_validated: ${cached.last_validated}`,
            cached
          );
        } else {
          updateTestSection(section, 'fail', 'Cache not properly storing license data', cached);
        }
      } catch (err) {
        updateTestSection(section, 'fail', `Failed: ${err.message}`);
      }

      // ----------------------------------------
      // Test 10: Multiple Rapid Validations (Stress)
      // ----------------------------------------
      section = createTestSection('10. Stress Test: 5 Rapid Validations');
      try {
        const times = [];
        for (let i = 0; i < 5; i++) {
          const start = performance.now();
          await sdk.validateLicense(CONFIG.LICENSE_KEY);
          times.push(performance.now() - start);
        }

        const avg = times.reduce((a, b) => a + b, 0) / times.length;
        const min = Math.min(...times);
        const max = Math.max(...times);

        updateTestSection(section, 'pass',
          `5 validations completed successfully\n` +
          `- Average: ${avg.toFixed(0)}ms\n` +
          `- Min: ${min.toFixed(0)}ms\n` +
          `- Max: ${max.toFixed(0)}ms\n` +
          `- Times: [${times.map(t => t.toFixed(0) + 'ms').join(', ')}]`
        );
      } catch (err) {
        updateTestSection(section, 'fail', `Failed: ${err.message}`);
      }

      // ----------------------------------------
      // Test 11: Error Handling - Invalid License
      // ----------------------------------------
      section = createTestSection('11. Error Handling: Invalid License');
      try {
        await sdk.validateLicense('INVALID-LICENSE-KEY-12345');
        updateTestSection(section, 'fail', 'Should have thrown an error');
      } catch (err) {
        if (err instanceof APIError) {
          updateTestSection(section, 'pass',
            `Correctly caught APIError\n` +
            `- Status: ${err.status}\n` +
            `- Error code: ${err.data?.error?.code}\n` +
            `- Error message: ${err.data?.error?.message}`,
            err.data
          );
        } else {
          updateTestSection(section, 'pass', `Caught error: ${err.message}`);
        }
      }

      // ----------------------------------------
      // Test 12: ConfigurationError Test
      // ----------------------------------------
      section = createTestSection('12. Error Handling: Missing productSlug');
      try {
        const badSdk = new LicenseSeat({
          apiKey: CONFIG.API_KEY,
          autoInitialize: false
          // Missing productSlug!
        });
        await badSdk.activate('TEST-KEY');
        updateTestSection(section, 'fail', 'Should have thrown ConfigurationError');
      } catch (err) {
        if (err instanceof ConfigurationError || err.name === 'ConfigurationError') {
          updateTestSection(section, 'pass', `Correctly threw ConfigurationError: ${err.message}`);
        } else {
          updateTestSection(section, 'pass', `Caught error (${err.name}): ${err.message}`);
        }
      }

      // ----------------------------------------
      // Test 13: Deactivation
      // ----------------------------------------
      section = createTestSection('13. License Deactivation');
      try {
        const result = await sdk.deactivate();

        if (result.object === 'deactivation' && result.activation_id && result.deactivated_at) {
          updateTestSection(section, 'pass',
            `License deactivated successfully\n` +
            `- object: ${result.object}\n` +
            `- activation_id: ${result.activation_id}\n` +
            `- deactivated_at: ${result.deactivated_at}`,
            result
          );
        } else {
          updateTestSection(section, 'fail', 'Unexpected response format', result);
        }
      } catch (err) {
        updateTestSection(section, 'fail', `Failed: ${err.message}`, err.data);
      }

      // ----------------------------------------
      // Test 14: Status After Deactivation
      // ----------------------------------------
      section = createTestSection('14. Status After Deactivation');
      try {
        const status = sdk.getStatus();
        if (status.status === 'inactive') {
          updateTestSection(section, 'pass', 'Status correctly returned to "inactive"', status);
        } else {
          updateTestSection(section, 'fail', `Expected "inactive", got "${status.status}"`, status);
        }
      } catch (err) {
        updateTestSection(section, 'fail', `Failed: ${err.message}`);
      }

      // ----------------------------------------
      // Test 15: Cache Cleared After Deactivation
      // ----------------------------------------
      section = createTestSection('15. Cache Cleared After Deactivation');
      try {
        const cached = sdk.cache.getLicense();
        if (cached === null) {
          updateTestSection(section, 'pass', 'Cache correctly cleared after deactivation');
        } else {
          updateTestSection(section, 'fail', 'Cache still contains data after deactivation', cached);
        }
      } catch (err) {
        updateTestSection(section, 'fail', `Failed: ${err.message}`);
      }

      // ----------------------------------------
      // Test 16: Re-activation
      // ----------------------------------------
      section = createTestSection('16. Re-activation After Deactivation');
      try {
        const result = await sdk.activate(CONFIG.LICENSE_KEY);
        updateTestSection(section, 'pass',
          `Re-activation successful\n` +
          `- device_id: ${result.device_id}\n` +
          `- activated_at: ${result.activated_at}`,
          result
        );
      } catch (err) {
        updateTestSection(section, 'fail', `Failed: ${err.message}`, err.data);
      }

      // ----------------------------------------
      // Test 17: Reset SDK
      // ----------------------------------------
      section = createTestSection('17. SDK Reset');
      try {
        sdk.reset();
        const status = sdk.getStatus();
        const cached = sdk.cache.getLicense();

        if (status.status === 'inactive' && cached === null) {
          updateTestSection(section, 'pass', 'SDK reset successfully - status inactive, cache cleared');
        } else {
          updateTestSection(section, 'fail', `Reset incomplete - status: ${status.status}, cached: ${cached !== null}`);
        }
      } catch (err) {
        updateTestSection(section, 'fail', `Failed: ${err.message}`);
      }

      // ----------------------------------------
      // Test 18: Singleton Pattern
      // ----------------------------------------
      section = createTestSection('18. Singleton Pattern (configure/getSharedInstance)');
      try {
        // Import singleton functions
        const { configure, getSharedInstance, resetSharedInstance } = await import('https://esm.sh/@licenseseat/js@0.3.0');

        configure({
          apiKey: CONFIG.API_KEY,
          productSlug: CONFIG.PRODUCT_SLUG,
          autoInitialize: false
        });

        const shared1 = getSharedInstance();
        const shared2 = getSharedInstance();

        if (shared1 === shared2 && shared1.config.productSlug === CONFIG.PRODUCT_SLUG) {
          updateTestSection(section, 'pass',
            `Singleton pattern working\n` +
            `- Same instance: ${shared1 === shared2}\n` +
            `- productSlug: ${shared1.config.productSlug}`
          );
        } else {
          updateTestSection(section, 'fail', 'Singleton instances do not match');
        }

        resetSharedInstance();
      } catch (err) {
        updateTestSection(section, 'fail', `Failed: ${err.message}`);
      }

      // ----------------------------------------
      // Final Summary
      // ----------------------------------------
      console.log(`\n${'='.repeat(50)}`);
      console.log(`TEST COMPLETE: ${passed} passed, ${failed} failed, ${skipped} skipped`);
      console.log(`${'='.repeat(50)}\n`);
    }

    // Button handlers
    document.getElementById('runTests').onclick = async () => {
      document.getElementById('runTests').disabled = true;
      await runTests();
      document.getElementById('runTests').disabled = false;
    };

    document.getElementById('resetSDK').onclick = () => {
      // Clear SDK storage but preserve test config
      const savedTestConfig = localStorage.getItem(CONFIG_STORAGE_KEY);
      localStorage.clear();
      if (savedTestConfig) localStorage.setItem(CONFIG_STORAGE_KEY, savedTestConfig);

      if (sdk) {
        try { sdk.destroy(); } catch (e) {}
      }
      sdk = null;
      testResults.innerHTML = '';
      eventLog.innerHTML = '';
      passed = 0; failed = 0; skipped = 0;
      summaryText.textContent = 'SDK reset. Click "Run All Tests" to start.';
    };
  </script>
</body>
</html>
